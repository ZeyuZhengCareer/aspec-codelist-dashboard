<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>A-SPEC Codelists Dashboard</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:white}
    .header{background-color:#494949;color:#fff;padding:2rem;margin-bottom:1rem;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 6px rgba(0,0,0,.2)}
    .logo-container{display:flex;align-items:center;background:rgba(255,255,255,.9);padding:.5rem;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,.1);transition:transform .2s ease}
    .logo-container:hover{transform:scale(1.05)}
    .title-section{text-align:center;flex-grow:1;margin:0 2rem}
    .title-section h1{font-size:2.5rem;font-weight:300;margin-bottom:.5rem}
    .title-section p{font-size:1.1rem;opacity:.9}
    .gissa-logo{background:rgba(255,255,255,.9);border-radius:8px;display:flex;align-items:center;justify-content:center;padding:.5rem;box-shadow:0 4px 6px rgba(0,0,0,.1);transition:transform .2s ease}
    .gissa-logo:hover{transform:scale(1.05)}
    .gissa-logo img{width:40px;height:40px}
    .main-content{max-width:1200px;margin:0 auto;padding:2rem}
    .section{background:rgba(255,255,255,.95);border-radius:12px;padding:2rem;margin-bottom:2rem;box-shadow:0 8px 32px rgba(0,0,0,.1);color:#333}
    .section-header{display:flex;align-items:center;margin-bottom:1.5rem}
    .section-icon{font-size:1.5rem;margin-right:.5rem}
    .section-title{font-size:1.5rem;font-weight:600;color:#2d3748}
    .search-section{display:none}
    .search-input{width:100%;padding:1rem;border:2px solid #667eea;border-radius:8px;font-size:1rem;background:#f3f4f6;color:#1e293b;box-shadow:0 2px 8px rgba(102,126,234,.1);transition:border-color .3s,box-shadow .3s}
    .search-input:focus{outline:none;border-color:#667eea}
    .codelist-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1rem;margin-top:1rem}
    .codelist-card{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:1rem;cursor:pointer;transition:all .3s ease}
    .codelist-card:hover{border-color:#667eea;box-shadow:0 4px 12px rgba(102,126,234,.15)}
    .codelist-card.selected{border-color:#667eea;background:#ebf8ff}
    .codelist-name{font-weight:600;color:#2d3748;margin-bottom:.5rem}
    .codelist-count{font-size:.8rem;color:#a0aec0}
    .workflow-steps{display:flex;justify-content:space-between;margin-bottom:2rem}
    .step{flex:1;text-align:center;padding:1rem;position:relative}
    .step::after{content:'';position:absolute;top:50%;right:-1px;width:2px;height:60%;background:#e2e8f0;transform:translateY(-50%)}
    .step:last-child::after{display:none}
    .step-number{width:40px;height:40px;border-radius:50%;background:#e2e8f0;color:#718096;display:flex;align-items:center;justify-content:center;margin:0 auto .5rem;font-weight:600}
    .step.active .step-number{background:#667eea;color:#fff}
    .step.completed .step-number{background:#48bb78;color:#fff}
    .step-title{font-weight:600;color:#2d3748;margin-bottom:.25rem}
    .step-description{font-size:.9rem;color:#fff}
    #download-master-btn{display:none !important}
    /* pager */
    #codelist-pager{display:flex;align-items:center;gap:.5rem;justify-content:flex-end;margin-top:12px}
    #codelist-pager button{padding:.4rem .7rem;border:1px solid #e2e8f0;border-radius:6px;background:#fff;cursor:pointer}
    #codelist-pager button:disabled{opacity:.5;cursor:not-allowed}
    #codelist-pager select{padding:.35rem .5rem;border:1px solid #e2e8f0;border-radius:6px;background:#fff;color:#334155}
    @media (max-width:768px){
      .header{flex-direction:column;gap:1rem}
      .title-section{margin:0}
      .title-section h1{font-size:2rem}
      .workflow-steps{flex-direction:column;gap:1rem}
      .step::after{display:none}
    }

    .codelist-spec{font-size:.8rem;color:#475569;margin-top:.35rem}

  </style>
</head>
<body>
  <div class="header">
    <div class="logo-container">
      <img src="A-Spec.jpg" alt="A-SPEC Logo" style="width:170px;height:auto;cursor:default" title="A-SPEC - Digital Data Specifications"/>
    </div>
    <div class="title-section">
      <h1><span style="color:#eceef0;font-weight:600;">Codelists Dashboard</span></h1>
      <p style="color:#e0e0e0;font-size:1rem;margin-top:.2rem;">Manage codes, abbreviated terms, and pick lists with intelligent search and selection</p>
    </div>
    <div class="gissa-logo">
      <img src="gissa-logo.png" alt="GISSA Logo" style="height:60px;width:auto;cursor:default" title="GISSA - Geospatial Information and Spatial Sciences Association"/>
    </div>
  </div>

  <div class="main-content">
    <!-- Steps -->
    <div class="workflow-steps">
      <div class="step active" id="step1">
        <div class="step-number">1</div>
        <div class="step-title">Load Master Codelist</div>
        <div class="step-description">The latest A-SPEC codelist file will be loaded automatically.</div>
      </div>
      <div class="step" id="step2">
        <div class="step-number">2</div>
        <div class="step-title">Select Target Codelist</div>
        <div class="step-description">Choose which codelist to add new codes to</div>
      </div>
      <div class="step" id="step3">
        <div class="step-number">3</div>
        <div class="step-title">Search & Create</div>
        <div class="step-description">Find matches or create new codes</div>
      </div>
    </div>

    <!-- Loaded file -->
    <div class="section" id="loaded-file-section">
      <div class="section-header">
        <span class="section-icon">üìÅ</span>
        <h2 class="section-title">Loaded Master Codelist</h2>
      </div>
      <div style="margin-bottom:1.2rem;">
        <strong>File:</strong>
        <span id="master-file-name" style="color:#667eea;">A-SPEC CODELISTS Version 2.0.5 MASTER WIP - 20250929.xlsx</span>
      </div>
      <p style="font-size:.9rem;color:#718096;margin-top:-.4rem;">
        Source file can also be downloaded from the
        <a href="https://www.a-specstandards.com.au/" target="_blank" style="color:#667eea;text-decoration:underline;">A-SPEC website</a>.
      </p>
      <button id="download-master-btn" style="padding:.75rem 1.5rem;background:#48bb78;color:#fff;border:none;border-radius:6px;cursor:pointer;">üì• Download Master Codelist</button>
    </div>

    <!-- Codelist selection -->
    <div class="section search-section" id="codelist-section">
      <div class="section-header">
        <span class="section-icon">üîç</span>
        <h2 class="section-title">Select Target Codelist</h2>
      </div>
      <input type="text" class="search-input" id="codelist-search" placeholder="Search for codelists... (e.g., 'pipe material', 'valve type')"/>
      <div class="codelist-grid" id="codelist-grid"></div>
      <!-- Pagination bar -->
      <div id="codelist-pager">
        <span style="color:#64748b;">Rows per page:</span>
        <select id="codelist-page-size">
          <option>12</option>
          <option selected>24</option>
          <option>48</option>
          <option>96</option>
        </select>
        <button id="codelist-prev">‚óÄ</button>
        <span id="codelist-page-info" style="min-width:110px;text-align:center;color:#64748b;">Page 1 / 1</span>
        <button id="codelist-next">‚ñ∂</button>
      </div>
    </div>

    <!-- Code creation -->
    <div class="section search-section" id="creation-section">
      <div class="section-header">
        <span class="section-icon">‚ûï</span>
        <h2 class="section-title">Search & Create Codes</h2>
      </div>
      <div id="creation-content">
        <p style="color:#718096;text-align:center;padding:2rem;">Select a codelist from above to begin searching and creating codes.</p>
      </div>
    </div>
  </div>

  <!-- XLSX parser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
/* -------------------- Config -------------------- */
const EMAIL_BACKEND_URL = "/api/send-codelist-email";
const EMAIL_TO   = "info@gissa.com.au";
const EMAIL_FROM = "noreply@gissa.com.au"; // must be a verified sender

// Hardcoded master file name in the same folder:
const MASTER_FILE_URL  = "A-SPEC CODELISTS Version 2.0.5 MASTER WIP - 20250929.xlsx";
const MASTER_FILE_NAME = "A-SPEC CODELISTS Version 2.0.5 MASTER WIP - 20250929.xlsx";

/* -------------------- Utils -------------------- */
function isValidEmail(s){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s); }
function pick(obj, ...keys){
  for (const k of keys){
    const v = obj && obj[k];
    if (v !== undefined && v !== null && String(v).trim() !== "") return String(v).trim();
  }
  return "";
}
function pad2(n){ return String(n).padStart(2,"0"); }
function formatDate(d){
  const dt = (d instanceof Date) ? d : new Date(d);
  return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`;
}
function normalizeDate(v){
  if (v == null || v === "") return "";

  if (typeof v === "string" && /^\d{4}-\d{2}-\d{2}$/.test(v)) return v;

  const asNum = (typeof v === "number") ? v : (/^\d+(\.\d+)?$/.test(v) ? Number(v) : NaN);
  if (!isNaN(asNum) && asNum > 59 && asNum < 80000) {
    const d = new Date(Date.UTC(1899, 11, 30));
    d.setUTCDate(d.getUTCDate() + Math.floor(asNum));
    return d.toISOString().slice(0, 10);
  }
  const t = Date.parse(v);
  if (!isNaN(t)) return new Date(t).toISOString().slice(0, 10);
  return "";
}

/* -------------------- Email helpers -------------------- */
async function blobToBase64(blob){
  const buf = await blob.arrayBuffer();
  let s = "", b = new Uint8Array(buf);
  for (let i = 0; i < b.length; i++) s += String.fromCharCode(b[i]);
  return btoa(s);
}

async function sendEmailViaBackend({ to = EMAIL_TO, subject, htmlBody, excelBlob = null, filename }) {
  const payload = {
    to,
    from: EMAIL_FROM,
    replyTo: EMAIL_TO,
    subject,
    html: htmlBody.replace(/\n/g, "<br>")
  };
  if (excelBlob) {
    payload.xlsxBase64 = await blobToBase64(excelBlob);
    payload.filename   = filename;
  }

  const resp = await fetch(EMAIL_BACKEND_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  const data = await resp.json().catch(()=> ({}));
  if (!resp.ok || data.ok === false) throw new Error(data.error || `Email send failed (HTTP ${resp.status})`);
}

/* -------------------- App state -------------------- */
let codelists = [];
let selectedCodelist = null;
let selectedExistingCode = null;
let selectedNewCode = null;
let sessionChanges = [];
let lastUserName = '', lastUserEmail = '', lastUserWantsConfirm = false;

/* -------------------- Data processing -------------------- */
function processCodelistData(data){
  const codelistMap = new Map();
  data.forEach(row=>{
    const codelistName = row['Codelist_Name'] || row['CODELIST_NAME'] || row['codelist_name'];
    if (!codelistName) return;
    if (!codelistMap.has(codelistName)){
      codelistMap.set(codelistName, {
        name: codelistName,
        description: row['Description'] || row['DESCRIPTION'] || '',
        codes: [],
        _specs: new Set()
      });
    }
    const entry = codelistMap.get(codelistName);
    entry.codes.push(row);

    const spec = (row['Spec'] || row['SPEC'] || '').toString().trim();
    if (spec) entry._specs.add(spec);
  });

  codelists = Array.from(codelistMap.values()).map(x => ({
    name: x.name,
    description: x.description,
    codes: x.codes,
    specs: Array.from(x._specs)
  }));

  // ‚úÖ sort alphabetically by name
  codelists.sort((a,b) => a.name.localeCompare(b.name));
}



/* -------------------- UI: Codelists (with pagination) -------------------- */
let CL_all = [];      // all codelists
let CL_filtered = []; // filtered by search
let CL_page = 1;      // 1-based
let CL_pageSize = 24;

function showCodelistSelection(){
  document.getElementById('codelist-section').style.display = 'block';

  // seed pagination arrays
  CL_all = codelists.slice();
  CL_filtered = CL_all.slice();

  const searchInput = document.getElementById('codelist-search');
  searchInput.addEventListener('input', handleCodelistSearch);

  const ps = document.getElementById('codelist-page-size');
  const prev = document.getElementById('codelist-prev');
  const next = document.getElementById('codelist-next');

  CL_pageSize = parseInt(ps.value, 10) || 24;

  ps.addEventListener('change', () => {
    CL_pageSize = parseInt(ps.value, 10) || 24;
    CL_page = 1;
    renderCodelistPage();
  });
  prev.addEventListener('click', () => {
    if (CL_page > 1) { CL_page--; renderCodelistPage(); }
  });
  next.addEventListener('click', () => {
    const totalPages = Math.max(1, Math.ceil(CL_filtered.length / CL_pageSize));
    if (CL_page < totalPages) { CL_page++; renderCodelistPage(); }
  });

  CL_page = 1;
  renderCodelistPage();
}

function handleCodelistSearch(e){
  const q = e.target.value.toLowerCase().trim();
  if (!q) {
    CL_filtered = CL_all.slice();
  } else {
    CL_filtered = CL_all.filter(c =>
      c.name.toLowerCase().includes(q) ||
      (c.description || '').toLowerCase().includes(q)
    );
  }
  CL_page = 1;
  renderCodelistPage();
}

function renderCodelistPage(){
  const total = CL_filtered.length;
  const totalPages = Math.max(1, Math.ceil(total / CL_pageSize));
  CL_page = Math.min(Math.max(1, CL_page), totalPages);

  const start = (CL_page - 1) * CL_pageSize;
  const pageItems = CL_filtered.slice(start, start + CL_pageSize);

  displayCodelists(pageItems);

  const info = document.getElementById('codelist-page-info');
  const prev = document.getElementById('codelist-prev');
  const next = document.getElementById('codelist-next');

  info.textContent = `Page ${CL_page} / ${totalPages}`;
  prev.disabled = (CL_page <= 1);
  next.disabled = (CL_page >= totalPages);
}

function displayCodelists(lists){
  const grid = document.getElementById('codelist-grid');

  const fmtSpecs = (arr)=>{
    const clean = (arr || []).filter(s => s && s.trim() !== '');
    if (clean.length === 0) return '';
    const shown = clean.slice(0,3).join(', ');
    const more = clean.length > 3 ? ` +${clean.length - 3} more` : '';
    return `Spec: ${shown}${more}`;
  };

  grid.innerHTML = lists.map(c => `
    <div class="codelist-card" onclick="selectCodelist(event, '${c.name.replace(/'/g, "\\'")}')">
      <div class="codelist-name">${c.name}</div>
      <div class="codelist-count">${c.codes.length} codes</div>
      ${c.specs && c.specs.length ? `<div class="codelist-spec">${fmtSpecs(c.specs)}</div>` : ''}
    </div>
  `).join('');
}


function selectCodelist(evt, codelistName){
  selectedCodelist = codelists.find(c => c.name === codelistName);

  document.querySelectorAll('.codelist-card').forEach(card => card.classList.remove('selected'));
  const card = evt.currentTarget || evt.target.closest('.codelist-card');
  if (card) card.classList.add('selected');

  updateStep(2,'completed'); 
  updateStep(3,'active');
  showCodeCreation();

  const creation = document.getElementById('creation-section');
  if (creation){ creation.scrollIntoView({behavior:'smooth', block:'start'}); }
}

/* -------------------- Existing + creation UI -------------------- */
function displayExistingCodes(){
  return selectedCodelist.codes.map((code,idx)=>`
    <div class="existing-code-item" data-index="${idx}" style="padding:1rem;border-bottom:1px solid #e2e8f0;cursor:pointer;transition:background-color .2s;"
         onmouseover="this.style.backgroundColor='#f7fafc'"
         onmouseout="this.style.backgroundColor='white'"
         onclick="selectExistingCode(${idx})">
      <div style="display:flex;justify-content:space-between;align-items:start;">
        <div style="flex:1;">
          <div style="font-weight:600;color:#2d3748;margin-bottom:.25rem;">
            ${pick(code,'Code_Value','CODE_Value','CODE_VALUE','Code','CODE') || 'N/A'}
          </div>
          <div style="color:#718096;margin-bottom:.25rem;">
            ${pick(code,'Description','DESCRIPTION') || 'No description'}
          </div>
          ${pick(code,'Comment','COMMENT','comment') ? `<div style="font-size:.9rem;color:#a0aec0;">${pick(code,'Comment','COMMENT','comment')}</div>` : ''}
        </div>
      </div>
    </div>
  `).join('');
}


function showCodeCreation(){
  document.getElementById('creation-section').style.display='block';
  const content = document.getElementById('creation-content');
  content.innerHTML = `
    <h3>Selected Codelist: ${selectedCodelist.name}</h3>
    <p style="color:#718096;margin-bottom:2rem;">This codelist contains ${selectedCodelist.codes.length} existing codes.</p>

    <div style="margin-bottom:2rem;">
      <h4 style="color:#2d3748;margin-bottom:1rem;">Current Codes in this Codelist:</h4>
      <div id="existing-codes-list" style="max-height:400px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:8px;">
        ${displayExistingCodes()}
      </div>
    </div>

    <input type="text" class="search-input" id="code-search"
           placeholder="Search for existing codes or describe what you need..." style="margin-bottom:1rem;"/>

    <div id="search-results"></div>

    <div style="margin-top:2rem;padding:1rem;background:#f7fafc;border-radius:8px;">
      <h4 style="color:#2d3748;margin-bottom:.5rem;">Options:</h4>
      <div style="font-size:.92rem;color:#64748b;margin-bottom:1rem;">
        Choose how you want to create a new code:
      </div>
      <div style="display:flex;gap:1rem;">
        <button id="create-auto-btn" style="padding:.75rem 1.5rem;background:#48bb78;color:#fff;border:none;border-radius:6px;cursor:pointer;flex:1;" onclick="showAutoCodeCreation()">
          ü§ñ Create New Code (System Generated)
        </button>
        <button id="create-manual-btn" style="padding:.75rem 1.5rem;background:#667eea;color:#fff;border:none;border-radius:6px;cursor:pointer;flex:1;" onclick="showManualCodeCreation()">
          ‚úèÔ∏è Create New Code (User Input)
        </button>
      </div>
    </div>

    <div id="create-auto-section" style="display:none;margin-top:2rem;padding:1rem;background:#f0fff4;border:1px solid #9ae6b4;border-radius:8px;">
      <h4 style="color:#2d3748;margin-bottom:1rem;">ü§ñ Create New Code - System Generated</h4>
      <div style="margin-bottom:1rem;">
        <label style="display:block;margin-bottom:.5rem;color:#4a5568;font-weight:600;">Description for new code:</label>
        <input type="text" id="new-code-description" placeholder="Enter description and system will generate code names..."
               style="width:100%;padding:.5rem;border:1px solid #e2e8f0;border-radius:4px;"/>
      </div>
      <div id="code-suggestions" style="margin-top:1rem;"></div>
    </div>

    <div id="create-manual-section" style="display:none;margin-top:2rem;padding:1rem;background:#ebf8ff;border:1px solid #90cdf4;border-radius:8px;">
      <h4 style="color:#2d3748;margin-bottom:1rem;">‚úèÔ∏è Create New Code - Manual Input</h4>
      <div style="margin-bottom:1rem;">
        <label style="display:block;margin-bottom:.5rem;color:#4a5568;font-weight:600;">Code Name (max 10 characters, no spaces):</label>
        <input type="text" id="manual-code-name" placeholder="e.g., VEGPLNT" maxlength="10"
               style="width:100%;padding:.5rem;border:1px solid #e2e8f0;border-radius:4px;text-transform:uppercase;"
               oninput="this.value = this.value.replace(/\\s/g, '').toUpperCase()"/>
        <div style="font-size:.85rem;color:#718096;margin-top:.25rem;">Enter code without spaces. Maximum 10 characters.</div>
      </div>
      <div style="margin-bottom:1rem;">
        <label style="display:block;margin-bottom:.5rem;color:#4a5568;font-weight:600;">Description:</label>
        <input type="text" id="manual-code-description" placeholder="Enter description for the code..."
               style="width:100%;padding:.5rem;border:1px solid #e2e8f0;border-radius:4px;"/>
      </div>
      <button onclick="validateAndCreateManualCode()" style="padding:.75rem 1.5rem;background:#48bb78;color:#fff;border:none;border-radius:6px;cursor:pointer;">
        ‚úÖ Validate & Continue
      </button>
      <div id="manual-validation-message" style="margin-top:1rem;"></div>
    </div>

    <div id="user-info-section" style="display:none;margin-top:2rem;padding:1rem;background:#ebf8ff;border:1px solid #90cdf4;border-radius:8px;">
      <h4 style="color:#2d3748;margin-bottom:1rem;">User Information</h4>

      <div style="margin-bottom:1rem;">
        <label style="display:block;margin-bottom:.5rem;color:#4a5568;font-weight:600;">Your Name/ID:</label>
        <input type="text" id="user-name" placeholder="Enter your name or user ID..."
               style="width:100%;padding:.5rem;border:1px solid #e2e8f0;border-radius:4px;"/>
      </div>

      <div style="margin-bottom:1rem;">
        <label style="display:block;margin-bottom:.5rem;color:#4a5568;font-weight:600;">Your Email (to receive confirmation):</label>
        <input type="email" id="user-email" placeholder="you@org.com"
               style="width:100%;padding:.5rem;border:1px solid #e2e8f0;border-radius:4px;"/>
        <label style="display:block;margin-top:.5rem;color:#4a5568;">
          <input type="checkbox" id="send-confirmation" checked style="margin-right:.5rem;"/>
          Email me a confirmation
        </label>
      </div>

      <div style="margin-bottom:1rem;">
        <label style="display:block;margin-bottom:.5rem;color:#4a5568;font-weight:600;">Comments (optional):</label>
        <textarea id="user-comments" placeholder="Any additional comments about this code..."
                  style="width:100%;padding:.5rem;border:1px solid #e2e8f0;border-radius:4px;height:80px;resize:vertical;"></textarea>
      </div>

      <div style="margin-bottom:1rem;">
        <label style="display:block;margin-bottom:.5rem;color:#4a5568;font-weight:600;">
          <input type="checkbox" id="send-notification" checked style="margin-right:.5rem;"/>
          Send email notification to info@gissa.com.au
        </label>
      </div>

      <button id="add-code-btn" style="padding:.75rem 2rem;background:#667eea;color:#fff;border:none;border-radius:6px;cursor:pointer;" onclick="addNewCodeToCodelist()">
        Add Code to Codelist
      </button>
    </div>
  `;

  document.getElementById('code-search').addEventListener('input', handleCodeSearch);
  document.getElementById('new-code-description').addEventListener('input', generateCodeSuggestions);
}

function selectExistingCode(index){
  selectedExistingCode = selectedCodelist.codes[index];
  document.querySelectorAll('.existing-code-item').forEach(i=>{i.style.backgroundColor='white';i.style.border='1px solid transparent';});
  const sel = document.querySelector(`[data-index="${index}"]`);
  sel.style.backgroundColor='#ebf8ff'; sel.style.border='1px solid #667eea';
}

function showAutoCodeCreation(){
  document.getElementById('create-auto-section').style.display='block';
  document.getElementById('create-manual-section').style.display='none';
  document.getElementById('new-code-description').focus();
}
function showManualCodeCreation(){
  document.getElementById('create-manual-section').style.display='block';
  document.getElementById('create-auto-section').style.display='none';
  document.getElementById('manual-code-name').focus();
}

/* -------------------- Create/Validate -------------------- */
function validateAndCreateManualCode(){
  const codeName = document.getElementById('manual-code-name').value.trim();
  const description = document.getElementById('manual-code-description').value.trim();
  const msgDiv = document.getElementById('manual-validation-message');

  if (!codeName){
    msgDiv.innerHTML = '<div style="background:#fee;border:1px solid #f88;padding:.75rem;border-radius:4px;color:#c00;">‚ùå Please enter a code name.</div>';
    return;
  }
  if (codeName.length > 10){
    msgDiv.innerHTML = '<div style="background:#fee;border:1px solid #f88;padding:.75rem;border-radius:4px;color:#c00;">‚ùå Code name must be 10 characters or less.</div>';
    return;
  }
  if (/\s/.test(codeName)){
    msgDiv.innerHTML = '<div style="background:#fee;border:1px solid #f88;padding:.75rem;border-radius:4px;color:#c00;">‚ùå Code name cannot contain spaces.</div>';
    return;
  }
  if (!description){
    msgDiv.innerHTML = '<div style="background:#fee;border:1px solid #f88;padding:.75rem;border-radius:4px;color:#c00;">‚ùå Please enter a description.</div>';
    return;
  }
  if (codeExists(codeName)){
    msgDiv.innerHTML = '<div style="background:#fee;border:1px solid #f88;padding:.75rem;border-radius:4px;color:#c00;">‚ùå This code already exists in the selected codelist.</div>';
    return;
  }

  msgDiv.innerHTML = `
    <div style="background:#f0fff4;border:1px solid #9ae6b4;padding:.75rem;border-radius:4px;color:#22543d;">
      ‚úÖ Code validated successfully!
      <div style="margin-top:.5rem;font-weight:600;">Code: ${codeName}</div>
      <div style="margin-top:.25rem;">Description: ${description}</div>
    </div>
  `;
  selectedNewCode = {code: codeName, description: description};
  document.getElementById('user-info-section').style.display='block';
  document.getElementById('user-info-section').scrollIntoView({behavior:'smooth'});
}

function generateCodeSuggestions(){
  const description = document.getElementById('new-code-description').value.trim();
  const suggestionsDiv = document.getElementById('code-suggestions');
  if (description.length<3){ suggestionsDiv.innerHTML=''; return; }

  const suggestions = createCodeSuggestions(description);
  suggestionsDiv.innerHTML = `
    <h5 style="color:#2d3748;margin-bottom:1rem;">Suggested Codes (meeting your criteria):</h5>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
    ${suggestions.map((s)=>`
      <div class="code-suggestion" data-code="${s.code}"
           style="padding:1rem;border:2px solid #e2e8f0;border-radius:6px;cursor:pointer;transition:all .2s;"
           onclick="selectCodeSuggestion('${s.code}','${description.replace(/'/g,"\\'")}')"
           onmouseover="this.style.borderColor='#667eea';this.style.backgroundColor='#f7fafc';"
           onmouseout="this.style.borderColor='#e2e8f0';this.style.backgroundColor='white';">
        <div style="font-weight:600;color:#2d3748;margin-bottom:.5rem;font-family:monospace;font-size:1.1rem;">${s.code}</div>
        <div style="font-size:.9rem;color:#718096;margin-bottom:.5rem;">${s.explanation}</div>
        <div style="font-size:.8rem;color:#a0aec0;">Length: ${s.code.length} ${!codeExists(s.code)?' ‚Ä¢ ‚úÖ Available':' ‚Ä¢ ‚ùå Already exists'}</div>
      </div>
    `).join('')}
    </div>
  `;
}

function createCodeSuggestions(description){
  const words = description.toUpperCase().split(/\s+/).filter(Boolean);
  const acronym = words.map(w=>w.charAt(0)).join('').substring(0,6);
  let smart='';
  if (words.length===1){ smart=words[0].substring(0,10); }
  else if (words.length===2){ smart=(words[0].substring(0,5)+words[1].substring(0,5)).substring(0,10); }
  else { smart=words.map((w,i)=> i<2 ? w.substring(0,3) : w.charAt(0)).join('').substring(0,10); }
  const base=[{code:acronym,explanation:'Acronym using first letter of each word'},
              {code:smart,explanation:'Smart abbreviation combining word parts'}];

  return base.filter(s=>s.code.length>0).map(s=>{
    let final=s.code, c=1;
    while(codeExists(final) && c<100){
      final = (final.length<9) ? s.code + c : s.code.substring(0,9)+c;
      c++;
    }
    return {...s, code:final};
  });
}

function codeExists(code){
  return selectedCodelist.codes.some(ec => pick(ec,'Code_Value','CODE_VALUE','Code','CODE').toUpperCase()===code.toUpperCase());
}

function selectCodeSuggestion(code, description){
  selectedNewCode = {code, description};
  document.querySelectorAll('.code-suggestion').forEach(i=>{i.style.borderColor='#e2e8f0';i.style.backgroundColor='#fff';});
  const sel = document.querySelector(`[data-code="${code}"]`);
  if (sel){ sel.style.borderColor='#48bb78'; sel.style.backgroundColor='#f0fff4'; }
  document.getElementById('user-info-section').style.display='block';
}

/* -------------------- Add new code -------------------- */
function addNewCodeToCodelist(){
  const userName = document.getElementById('user-name').value.trim();
  const userComments = document.getElementById('user-comments').value.trim();
  const userEmail = document.getElementById('user-email').value.trim();
  const wantsConfirm = document.getElementById('send-confirmation').checked;

  if (wantsConfirm && !isValidEmail(userEmail)) {
    alert('Please enter a valid email address to receive a confirmation.');
    return;
  }
  lastUserName = userName;
  lastUserEmail = userEmail;
  lastUserWantsConfirm = wantsConfirm;

  if (!selectedNewCode){ alert('Please select a code suggestion first.'); return; }
  if (!userName){ alert('Please enter your name or user ID.'); return; }

  const defaultSpecForCodelist =
    pick(selectedCodelist.codes.find(r => pick(r,'Spec','SPEC')) || {}, 'Spec','SPEC');

  const newCodeEntry = {
    'Spec': defaultSpecForCodelist,
    'Code_Value': selectedNewCode.code,
    'Description': selectedNewCode.description,
    'Codelist_Name': selectedCodelist.name,
    'Comment': userComments,
    'Date_Modified': formatDate(new Date()),
    'Added_By': userName,
    'Status': 'Active',
    'Added - A, Modified - M, Removed - R': 'A'
  };

  if (!selectedCodelist.codes.some(c => pick(c,'Code_Value','CODE_VALUE').toUpperCase()===newCodeEntry.Code_Value.toUpperCase())){
    selectedCodelist.codes.push(newCodeEntry);
    sessionChanges.push({
      type:'added', code:newCodeEntry.Code_Value, description:newCodeEntry.Description,
      codelist:selectedCodelist.name, timestamp:new Date().toISOString(), addedBy:userName
    });
    document.getElementById('existing-codes-list').innerHTML = displayExistingCodes();
  }
  showCodeAddedSuccess(newCodeEntry);

  document.getElementById('create-auto-section').style.display='none';
  document.getElementById('create-manual-section').style.display='none';
  document.getElementById('user-info-section').style.display='none';
  document.getElementById('new-code-description').value='';
  const n1 = document.getElementById('manual-code-name'); if(n1) n1.value='';
  const n2 = document.getElementById('manual-code-description'); if(n2) n2.value='';
  selectedNewCode=null;
}

function showCodeAddedSuccess(newCodeEntry){
  const msg=document.createElement('div');
  msg.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#f0fff4;border:2px solid #48bb78;padding:2rem;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,.2);z-index:1000;text-align:center;';
  msg.innerHTML=`
    <h3 style="color:#22543d;margin-bottom:1rem;">‚úÖ Code Added Successfully!</h3>
    <p style="color:#2f855a;margin-bottom:1rem;"><strong>${newCodeEntry.Code_Value}</strong> has been added to <strong>${selectedCodelist.name}</strong></p>
    <div style="font-size:.9rem;color:#2f855a;margin-bottom:1.5rem;">Total changes this session: ${sessionChanges.length}</div>
    <button id="continue-after-success" style="padding:.5rem 1.2rem;background:#667eea;color:#fff;border:none;border-radius:5px;cursor:pointer;">Continue</button>
  `;
  document.body.appendChild(msg);
  document.getElementById('continue-after-success').onclick=function(){
    msg.remove(); askForMoreChanges();
  };
}

/* -------------------- Finish / email flow -------------------- */
function askForMoreChanges(){
  const modal=document.createElement('div');
  modal.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:10000;display:flex;justify-content:center;align-items:center;';
  const content=document.createElement('div');
  content.style.cssText='background:#fff;padding:2rem;border-radius:12px;max-width:600px;box-shadow:0 20px 40px rgba(0,0,0,.3);text-align:center;';
  content.innerHTML=`
    <h2 style="color:#2d3748;margin-bottom:1.5rem;"><span style="background:#e0eaff;border-radius:6px;padding:.15em .45em;font-size:1.2em;margin-right:.5em;">üîÑ</span>Continue Making Changes?</h2>
    <div style="background:#f7fafc;border-radius:8px;padding:1rem;margin-bottom:1.5rem;text-align:left;">
      <h4 style="color:#2d3748;margin-bottom:.75rem;">Changes Made This Session:</h4>
      ${sessionChanges.length===0
        ? `<div style="color:#a0aec0;">No changes made yet.</div>`
        : sessionChanges.map(ch=>`
          <div style="margin-bottom:.6rem;padding:.5rem .8rem;background:#fff;border-radius:5px;border-left:4px solid #48bb78;">
            <div style="font-weight:600;color:#18a058;">${ch.code}</div>
            <div style="color:#4b5563;">${ch.description || '<i>No description</i>'}</div>
            <div style="font-size:.92em;color:#64748b;">Added to: <b>${ch.codelist}</b></div>
          </div>`).join('')}
    </div>
    <p style="color:#4a5568;margin-bottom:2rem;">Do you want to make more changes before sending the email notification?</p>
    <div style="display:flex;gap:1rem;justify-content:center;">
      <button onclick="continueChanges()" style="padding:.75rem 1.5rem;background:#667eea;color:#fff;border:none;border-radius:6px;cursor:pointer;">‚ûï Make More Changes</button>
      <button onclick="finalizeAndSendEmail()" style="padding:.75rem 1.5rem;background:#48bb78;color:#fff;border:none;border-radius:6px;cursor:pointer;">üìß Send Email Notification</button>
    </div>
  `;
  modal.className='changes-modal';
  modal.appendChild(content);
  document.body.appendChild(modal);
  window.continueChanges=()=>{modal.remove();};
  window.finalizeAndSendEmail=()=>{modal.remove();sendBatchEmailNotification();};
}

function sendBatchEmailNotification(){
  const userName = sessionChanges.find(c=>c.addedBy)?.addedBy || 'System User';
  sendEmailNotification(null, userName, sessionChanges);
}

function sendEmailNotification(newCodeEntry, userName, changes=null){
  const arr = changes || [{
    code:newCodeEntry.Code_Value,
    description:newCodeEntry.Description,
    codelist:selectedCodelist.name,
    type:'added'
  }];

  const updatedExcelBlob = generateUpdatedExcelFile();
  const d=new Date(), iso=d.toISOString().split('T')[0].replace(/-/g,'');
  const subject = `A-SPEC New Code Update Notification - ${d.toLocaleDateString('en-AU',{year:'numeric',month:'long',day:'numeric'})}`;
  const newTerms = arr.map(ch=>`* **${ch.code}** - ${ch.description} (${ch.codelist})`).join('\n');
  const body =
`Dear A-SPEC Team,

There has been a new code created by an A-Speccer. Here's what's changed:

**New Code/s Added**
${newTerms}

**Quick Stats**
* **Total codes in database:** ${getTotalTermsCount()}
* **New code/s this update:** ${arr.length}
* **Last updated:** ${d.toLocaleDateString('en-AU',{year:'numeric',month:'long',day:'numeric'})}
* **Updated by:** ${userName}

**What's Next?**
Please review these changes and update any documentation or processes that reference these codes.

**Questions or feedback?** Reply to this email or contact us at info@gissa.com.au.

---
Please Note: This is an automated notification from the A-SPEC Codelists Dashboard.`;

  const filename = `A-SPEC_CODELISTS_v2.0.6_${iso}.xlsx`;
  showEmailPreview(subject, body, updatedExcelBlob, filename, arr, {
    userName, userEmail: lastUserEmail, wantConfirm: lastUserWantsConfirm
  });
}

function getTotalTermsCount(){
  return codelists.reduce((t,c)=>t+c.codes.length,0);
}

/* -------------------- Export (Excel) -------------------- */
function generateUpdatedExcelFile(){
  try{
    const wb = XLSX.utils.book_new();
    const columns = [
      "Spec","Spec_Coverage","Codelist_Name","Code_Value","Description","Comment",
      "Date_Modified","Added - A, Modified - M, Removed - R","Change_Author","Category"
    ];
    const masterData=[];
    codelists.forEach(c=>{
      c.codes.forEach(code=>{
        const dateOut = normalizeDate(pick(code,'Date_Modified','DATE_MODIFIED','Date_Added','DATE_ADDED'));
        masterData.push({
          "Spec": pick(code, 'Spec','SPEC'),
          "Spec_Coverage": pick(code, 'Spec_Coverage','SPEC_COVERAGE','Current Versions 2019 & 2023'),
          "Codelist_Name": c.name,
          "Code_Value": pick(code,'Code_Value','CODE_VALUE','Code','CODE'),
          "Description": pick(code,'Description','DESCRIPTION'),
          "Comment": pick(code,'Comment','COMMENT','comment'),
          "Date_Modified": dateOut,
          "Added - A, Modified - M, Removed - R": pick(code, 'Added - A, Modified - M, Removed - R','ChangeFlag') || 'A',
          "Change_Author": pick(code,'Change_Author','CHANGE_AUTHOR','Added_By','ADDED_BY'),
          "Category": pick(code,'Category')
        });
      });
    });
    const ws = XLSX.utils.json_to_sheet(masterData, { header: columns });
    XLSX.utils.book_append_sheet(wb, ws, "CODELIST_MASTER");
    const buf = XLSX.write(wb,{bookType:'xlsx',type:'array'});
    return new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  }catch(e){ console.error('Error generating Excel:',e); return null; }
}

/* -------------------- Email preview & send -------------------- */
function showEmailPreview(subject, body, excelBlob, filename, changes, opts = {}){
  const { userName = 'User', userEmail = '', wantConfirm = false } = opts;
  const modal=document.createElement('div');
  modal.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:10000;display:flex;justify-content:center;align-items:center;';
  const content=document.createElement('div');
  content.style.cssText='background:#fff;padding:2rem;border-radius:12px;max-width:800px;max-height:80vh;overflow-y:auto;box-shadow:0 20px 40px rgba(0,0,0,.3);';
  content.innerHTML=`
    <h2 style="color:#000;margin-bottom:1.5rem;border-bottom:2px solid #667eea;padding-bottom:.5rem;">üìß Email Notification Preview</h2>
    <div style="margin-bottom:1.5rem;padding:1rem;background:#f7fafc;border-radius:8px;color:#000;">
      <strong>To:</strong> info@gissa.com.au<br>
      <strong>Subject:</strong> ${subject}<br>
      <strong>Attachment:</strong> üìé ${filename}
    </div>
    <div style="background:#f9f9f9;border:1px solid #e2e8f0;border-radius:8px;padding:1.5rem;margin-bottom:2rem;white-space:pre-line;font-family:'Courier New',monospace;font-size:.9rem;line-height:1.4;color:#000;">${body}</div>
    <div style="margin-bottom:1.5rem;padding:1rem;background:#ebf8ff;border-radius:8px;color:#000;">
      <h4 style="margin-bottom:.5rem;">üìä Session Summary:</h4>
      <p><strong>Total changes:</strong> ${changes?changes.length:1}</p>
      <p><strong>File version:</strong> ${filename}</p>
      <p><strong>Codelists affected:</strong> ${changes ? [...new Set(changes.map(c=>c.codelist))].join(', ') : (selectedCodelist?selectedCodelist.name:'')}</p>
    </div>
    <div style="display:flex;gap:1rem;justify-content:center;">
      <button id="download-excel" style="padding:.75rem 1.5rem;background:#48bb78;color:#fff;border:none;border-radius:6px;cursor:pointer;">üìÅ Download ${filename}</button>
      <button id="simulate-send" style="padding:.75rem 1.5rem;background:#667eea;color:#fff;border:none;border-radius:6px;cursor:pointer;">üì§ Send Email</button>
      <button id="close-reset" style="padding:.75rem 1.5rem;background:#a0aec0;color:#fff;border:none;border-radius:6px;cursor:pointer;">Close & Reset Session</button>
    </div>`;
  modal.className='modal'; modal.appendChild(content); document.body.appendChild(modal);

  content.querySelector('#download-excel').addEventListener('click',()=>{
    if (excelBlob){ const url=URL.createObjectURL(excelBlob); const a=document.createElement('a'); a.href=url;a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url); }
  });

  content.querySelector('#close-reset').addEventListener('click',()=>{
    modal.remove(); resetSession(true);
  });

  const sendBtn = content.querySelector('#simulate-send');
  sendBtn.addEventListener('click', async () => {
    try {
      sendBtn.disabled = true;
      sendBtn.textContent = "Sending...";
      await sendEmailViaBackend({ subject, htmlBody: body, excelBlob, filename });

      if (wantConfirm && userEmail) {
        const confirmSubject = "RE: We received your A-SPEC Codelist update";
        const confirmBody =
`Hi ${userName},

You are receiving this email as confirmation that your submission has been received by the A-SPEC team and includes the following change/s.

Quick summary (${changes ? changes.length : 1} change${(changes && changes.length!==1) ? 's' : ''}):
${(changes || []).map(c=>`‚Ä¢ ${c.code} ‚Äî ${c.description} (${c.codelist})`).join('\\n')}

**What's Next?**
The A-SPEC team will review these changes and update any documentation or processes that reference these codes.

**Questions or feedback?** Reply to this email or contact us at info@gissa.com.au.

Thanks for staying up to date!

Best regards,
The A-SPEC team
---
Please Note: This is an automated notification from the A-SPEC Codelists Dashboard.`;
        await sendEmailViaBackend({ to: userEmail, subject: confirmSubject, htmlBody: confirmBody });
      }
      sendBtn.textContent = "‚úÖ Email sent";
      sendBtn.style.background = "#48bb78";
      showEmailSentConfirmation();
    } catch (e) {
      alert("Send failed: " + e.message);
      sendBtn.disabled = false;
      sendBtn.textContent = "üì§ Send Email";
    }
  });
}

function showEmailSentConfirmation(){
  const msg=document.createElement('div');
  msg.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#f0fff4;border:2px solid #48bb78;padding:2rem;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,.2);z-index:11000;text-align:center;';
  msg.innerHTML=`
    <h3 style="color:#22543d;margin-bottom:1rem;">üìß Email Notification Sent!</h3>
    <p style="color:#2f855a;margin-bottom:1rem;">Notification with ${sessionChanges.length} change(s) sent to info@gissa.com.au</p>
    <button id="complete-session" style="padding:.5rem 1rem;background:#48bb78;color:#fff;border:none;border-radius:4px;cursor:pointer;">Complete Session</button>
  `;
  document.body.appendChild(msg);
  document.getElementById('complete-session').onclick=function(){
    msg.remove(); resetSession(true);
  };
}

/* -------------------- Reset & reload -------------------- */
function updateStep(n,status){
  const step=document.getElementById(`step${n}`);
  step.className=`step ${status}`;
}

function resetSession(deep=false){
  sessionChanges=[]; selectedCodelist=null; selectedExistingCode=null; selectedNewCode=null;

  const ids = ['codelist-section','creation-section','codelist-search','code-search',
               'new-code-description','manual-code-name','manual-code-description',
               'user-name','user-comments'];
  ids.forEach(id => { const el=document.getElementById(id); if(!el) return;
    if (el.tagName==='DIV' || el.tagName==='SECTION') { if (id.endsWith('-section')) el.style.display='none'; }
    else { el.value=''; }
  });
  const clearHTML = ['search-results','code-suggestions','manual-validation-message'];
  clearHTML.forEach(id=>{ const el=document.getElementById(id); if(el) el.innerHTML=''; });

  const userInfoSection=document.getElementById('user-info-section'); if (userInfoSection) userInfoSection.style.display='none';
  document.querySelectorAll('.modal, .changes-modal').forEach(m=>m.remove());

  updateStep(1,'active'); updateStep(2,''); updateStep(3,'');
  document.querySelectorAll('.codelist-card').forEach(card=>card.classList.remove('selected'));
  document.querySelectorAll('.existing-code-item').forEach(i=>{i.style.backgroundColor='white';i.style.border='1px solid transparent';});

  codelists=[];
  if (deep) loadMasterFile();
}

/* -------------------- Search across all codelists -------------------- */
function handleCodeSearch(e){
  const q=e.target.value.toLowerCase().trim();
  const results=document.getElementById('search-results');
  if (q.length<2){ results.innerHTML=''; return; }

  let matches=[];
  codelists.forEach(cl=>{
    cl.codes.forEach(code=>{
      const fields=[
        pick(code,'Code_Value','CODE_Value','CODE_VALUE','Code','CODE'),
        pick(code,'Description','DESCRIPTION'),
        pick(code,'Comment','COMMENT','comment')
      ].join(' ').toLowerCase();
      if (fields.includes(q)){
        matches.push({
          codelistName:cl.name,
          code:pick(code,'Code_Value','CODE_Value','CODE_VALUE','Code','CODE') || 'N/A',
          description:pick(code,'Description','DESCRIPTION') || 'No description',
          comment:pick(code,'Comment','COMMENT','comment') || '',
          spec:pick(code,'Spec','SPEC')
        });
      }
    });
  });
  matches = matches.slice(0,20);

  if (matches.length>0){
    results.innerHTML = `
      <h4 style="color:#2d3748;margin-bottom:1rem;">Found ${matches.length} matching codes OR description (across all codelists):</h4>
      <div style="max-height:400px;overflow-y:auto;">
        ${matches.map(item=>{
          const inSelected=item.codelistName===selectedCodelist.name;
          const color=inSelected?'#22c55e':'#ef4444';
          const btn = !inSelected ? `
            <button onclick="addSearchedCodeToCodelist('${item.code.replace(/'/g,"\\'")}','${item.description.replace(/'/g,"\\'")}','${item.codelistName.replace(/'/g,"\\'")}','${(item.spec||'').replace(/'/g,"\\'")}'
                    )" style="margin-top:.5rem;padding:.5rem 1rem;background:#48bb78;color:#fff;border:none;border-radius:4px;cursor:pointer;">
              ‚ûï Add to "${selectedCodelist.name}"
            </button>` : '';
          return `
            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:6px;padding:1rem;margin-bottom:.5rem;">
              <div style="font-weight:600;color:#2d3748;">${item.code}</div>
              <div style="color:#718096;margin:.25rem 0;">${item.description}</div>
              <div style="color:${color};font-size:.95rem;">In: <b>${item.codelistName}</b></div>
              ${item.comment ? `<div style="font-size:.9rem;color:#a0aec0;">${item.comment}</div>` : ''}
              ${btn}
            </div>`;
        }).join('')}
      </div>`;
  }else{
    results.innerHTML = `
      <div style="background:#fef5e7;border:1px solid #f6ad55;border-radius:6px;padding:1rem;margin-bottom:1rem;">
        <h4 style="color:#c05621;margin-bottom:.5rem;">No existing codes found for "${e.target.value.trim()}" in any codelist</h4>
        <p style="color:#9c4221;">Use <b>Create New Code</b> below, or create directly from your search:</p>
        <button onclick="createNewWithSearchTerm('${e.target.value.trim().replace(/'/g,"\\'")}')" style="margin-top:.5rem;padding:.5rem 1rem;background:#48bb78;color:#fff;border:none;border-radius:4px;cursor:pointer;">
          Create New Code: "${e.target.value.trim()}"
        </button>
      </div>`;
  }
}

function createNewWithSearchTerm(term){
  showAutoCodeCreation();
  document.getElementById('new-code-description').value=term;
  generateCodeSuggestions();
}

window.addSearchedCodeToCodelist=function(code,desc,fromName,spec){
  const entry={
    'Spec': pick({Spec:spec},'Spec'),
    'Code_Value':code,
    'Description':desc,
    'Codelist_Name':selectedCodelist.name,
    'Comment':'',
    'Date_Modified':formatDate(new Date()),
    'Added_By':'Imported from '+fromName,
    'Status':'Active',
    'Added - A, Modified - M, Removed - R':'A'
  };
  if (!selectedCodelist.codes.some(c=> pick(c,'Code_Value','CODE_VALUE').toUpperCase()===code.toUpperCase())){
    selectedCodelist.codes.push(entry);
    sessionChanges.push({type:'added',code:entry.Code_Value,description:entry.Description,codelist:selectedCodelist.name,timestamp:new Date().toISOString(),addedBy:entry.Added_By});
    document.getElementById('existing-codes-list').innerHTML=displayExistingCodes();
  }
  showCodeAddedSuccess(entry);
}

/* -------------------- Load file & boot -------------------- */
async function loadMasterFile(){
  try{
    const resp = await fetch(MASTER_FILE_URL, { cache: "no-cache" });
    if (!resp.ok) throw new Error("Failed to load master file!");
    const buffer = await resp.arrayBuffer();

    const workbook = XLSX.read(buffer, { type:'array' });
    const sheetName = workbook.SheetNames.find(n => n.toUpperCase().includes('CODELIST_MASTER') || n.toUpperCase().includes('MASTER')) || workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const jsonData  = XLSX.utils.sheet_to_json(worksheet);

    processCodelistData(jsonData);
    updateStep(1,'completed'); updateStep(2,'active'); showCodelistSelection();
  }catch(err){
    alert('Error loading master codelist: ' + err.message + '\nTip: put the XLSX in the same folder as this HTML and check the exact file name.');
    console.error(err);
  }
}

document.addEventListener('DOMContentLoaded',()=>{
  const as = document.querySelector('.logo-container img');
  if (as) as.addEventListener('click',()=>window.open('https://www.aspec.org.au','_blank'));
  const gl = document.querySelector('.gissa-logo img');
  if (gl) gl.addEventListener('click',()=>window.open('https://www.gissa.org.au','_blank'));

  document.getElementById('download-master-btn').onclick = function(){
    const a=document.createElement('a'); a.href=MASTER_FILE_URL; a.download=MASTER_FILE_NAME; document.body.appendChild(a); a.click(); document.body.removeChild(a);
  };

  loadMasterFile();
});
  </script>
</body>
</html>
